#!/usr/bin/env bash
# delete old testacc databases and sweep non-main branches from persistent testacc databases

set -eou pipefail

ORG="${ORG:-planetscale-terraform-testing}"
AGE_SECS="${AGE_SECS:-86400}"
DRY_RUN="${DRY_RUN:-true}"

pscale database list --org "$ORG" --format json |
  jq --arg age "$AGE_SECS" \
    -r '.[] | select(
    (.name | startswith("testacc")) and
    (.name != "testacc-vitess") and
    (.name != "testacc-postgres") and
    (.created_at | sub("\\.\\d+"; "") | fromdateiso8601 < (now - ($age | tonumber))))
    .name' |
  while read -r dbname; do
    if [ "$DRY_RUN" = "true" ]; then
      echo "[DRY RUN] Would delete database: $dbname"
    else
      pscale database delete "$dbname" --org "$ORG" --force
    fi
  done

for dbname in testacc-vitess testacc-postgres; do
  pscale branch list "$dbname" --org "$ORG" --format json |
    jq -r '.[] | select(.name != "main") | .name' |
    while read -r branch; do
      if [ "$DRY_RUN" = "true" ]; then
        echo "[DRY RUN] Would delete branch: $dbname/$branch"
      else
        pscale branch delete "$dbname" "$branch" --org "$ORG" --force
      fi
    done
done
